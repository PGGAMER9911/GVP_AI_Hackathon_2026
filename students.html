<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Students — AttendTrack</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="app-container">
        <aside class="sidebar"></aside>

        <main class="main-content">
            <div class="page-header">
                <h1>Student Management</h1>
                <p>Add, search, and manage students across all courses</p>
            </div>

            <!-- Add Student Form -->
            <div class="card">
                <div class="card-header">Add New Student</div>
                <form id="addForm">
                    <div class="form-row">
                        <div class="form-group" style="flex:1; min-width:180px;">
                            <label for="stuName">Full Name</label>
                            <input type="text" id="stuName" placeholder="e.g. Rahul Sharma" required>
                        </div>
                        <div class="form-group" style="flex:0.6; min-width:120px;">
                            <label for="stuRoll">Roll Number</label>
                            <input type="text" id="stuRoll" placeholder="e.g. BCA103" required>
                        </div>
                        <div class="form-group" style="flex:0.8; min-width:160px;">
                            <label for="stuCourse">Course</label>
                            <select id="stuCourse" required onchange="updateSemesterDropdown()">
                                <option value="">-- Select Course --</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:0.5; min-width:120px;">
                            <label for="stuSem">Semester</label>
                            <select id="stuSem" required disabled>
                                <option value="">-- Select course first --</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:0.5; min-width:120px;">
                            <label for="stuYear">Academic Year</label>
                            <select id="stuYear" required>
                                <option value="2025-26" selected>2025-26</option>
                                <option value="2024-25">2024-25</option>
                                <option value="2026-27">2026-27</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Add Student</button>
                    </div>
                </form>
            </div>

            <!-- Filter & Search -->
            <div class="card">
                <div class="form-row">
                    <div class="form-group" style="flex:0.6; min-width:140px;">
                        <label for="filterCourse">Filter by Course</label>
                        <select id="filterCourse" onchange="renderStudents()">
                            <option value="">All Courses</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="searchInput">Search</label>
                        <input type="text" id="searchInput" class="search-bar" placeholder="Search by name or roll number..." oninput="renderStudents()">
                    </div>
                </div>
            </div>

            <!-- Student Table -->
            <div class="card">
                <div class="card-header">
                    Enrolled Students
                    <span class="ai-label">AI Remarks</span>
                </div>
                <p class="ai-note">Remarks are auto-generated using rule-based thresholds on semester average marks. Not a real AI API.</p>
                <table>
                    <thead>
                        <tr>
                            <th>Roll</th>
                            <th>Name</th>
                            <th>Course</th>
                            <th>Semester</th>
                            <th>Year</th>
                            <th>AI Remark</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="studentBody"></tbody>
                </table>
                <p id="noStudents" class="empty-state" style="display:none;">No students found</p>
            </div>
        </main>
    </div>

    <script src="js/main.js"></script>
    <script>
        Auth.guard();
        renderSidebar('students');

        /* Populate course dropdowns */
        function initDropdowns() {
            var courseSelect = document.getElementById('stuCourse');
            var filterSelect = document.getElementById('filterCourse');

            courseSelect.innerHTML = '<option value="">-- Select Course --</option>';
            filterSelect.innerHTML = '<option value="">All Courses</option>';

            for (var code in COURSES) {
                courseSelect.innerHTML += '<option value="' + code + '">' + COURSES[code].name + ' (' + code + ')</option>';
                filterSelect.innerHTML += '<option value="' + code + '">' + code + '</option>';
            }
        }

        /* Auto-update semester dropdown based on selected course */
        function updateSemesterDropdown() {
            var course = document.getElementById('stuCourse').value;
            var semSelect = document.getElementById('stuSem');

            if (!course) {
                semSelect.innerHTML = '<option value="">-- Select course first --</option>';
                semSelect.disabled = true;
                return;
            }

            var opts = getSemesterOptions(course);
            semSelect.innerHTML = opts.map(function(o) {
                return '<option value="' + o.value + '">' + o.label + '</option>';
            }).join('');
            semSelect.disabled = false;
        }

        /* Add student handler */
        document.getElementById('addForm').addEventListener('submit', function(e) {
            e.preventDefault();

            var result = Store.addStudent({
                name: document.getElementById('stuName').value,
                roll: document.getElementById('stuRoll').value,
                course: document.getElementById('stuCourse').value,
                semester: document.getElementById('stuSem').value,
                academicYear: document.getElementById('stuYear').value
            });

            if (result.success) {
                Utils.showToast(result.message, 'success');
                document.getElementById('addForm').reset();
                document.getElementById('stuSem').disabled = true;
                document.getElementById('stuSem').innerHTML = '<option value="">-- Select course first --</option>';
                renderStudents();
            } else {
                Utils.showToast(result.message, 'danger');
            }
        });

        /* Render student table with filters and search */
        function renderStudents() {
            var students = Store.getStudents();
            var filter = document.getElementById('filterCourse').value;
            var search = document.getElementById('searchInput').value.toLowerCase().trim();

            if (filter) {
                students = students.filter(function(s) { return s.course === filter; });
            }
            if (search) {
                students = students.filter(function(s) {
                    return s.name.toLowerCase().indexOf(search) !== -1 ||
                           s.roll.toLowerCase().indexOf(search) !== -1;
                });
            }

            var tbody = document.getElementById('studentBody');
            var noMsg = document.getElementById('noStudents');

            if (students.length === 0) {
                tbody.innerHTML = '';
                noMsg.style.display = 'block';
                return;
            }
            noMsg.style.display = 'none';

            tbody.innerHTML = students.map(function(s) {
                var semLabel = s.course === 'PHD' ? 'Year ' + s.semester : 'Sem ' + s.semester;
                var avg = Store.getStudentSemesterAvg(s.id);
                var remark = avg > 0 ? Performance.getRemark(avg) : { text: '—', class: '' };

                return '<tr>'
                    + '<td>' + Utils.sanitize(s.roll) + '</td>'
                    + '<td>' + Utils.sanitize(s.name) + '</td>'
                    + '<td>' + s.course + '</td>'
                    + '<td>' + semLabel + '</td>'
                    + '<td>' + (s.academicYear || '—') + '</td>'
                    + '<td>' + (avg > 0 ? '<span class="badge ' + remark.class + '">' + remark.text + '</span>' : '—') + '</td>'
                    + '<td><button class="btn btn-danger btn-sm" onclick="deleteStudent(\'' + s.id + '\')">Delete</button></td>'
                    + '</tr>';
            }).join('');
        }

        /* Delete student with confirmation */
        function deleteStudent(id) {
            if (!confirm('Are you sure you want to delete this student? This will also remove their attendance records.')) return;

            var result = Store.deleteStudent(id);
            if (result.success) {
                Utils.showToast(result.message, 'success');
                renderStudents();
            } else {
                Utils.showToast(result.message, 'danger');
            }
        }

        function onDataReady() { initDropdowns(); renderStudents(); }
        initDropdowns();
        renderStudents();
    </script>

</body>
</html>
